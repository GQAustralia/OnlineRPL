{% extends 'base.html.twig' %}
{% block title %}GQ - RPL Messages Inbox{% endblock %}
{% block stylesheets %}
<link rel="stylesheet" href="{{ asset('public/css/pages/all/candidate.css') }}">
<link rel="stylesheet" href="{{ asset('public/css/jquery-ui.css') }}">
{% endblock %}
{% block body %}
<div class="body_section message_section">
    <div class="">		
        {% set currentPath = app.request.uri %}
        {% set parameters = currentPath|split('?') %}
        {% set userRole = app.security.getToken().getUser().getRoles() %}
        {% set userId = app.security.getToken().getUser().getId() %} 
    
    <!-- FOR MOBILE -->
    <div class="">        
              
            <div class="hidden-sm hidden-md hidden-lg">
            <div class="mobile_version">
                <div class="">
    {% for flashMessage in app.session.flashbag.get('msgnotice') %}
    <div class="" id="profile_suc_msg">
    <div class="gq-id-files-upload-success-text">
      <span>
        {{ flashMessage }}</span>
    </div>
    </div>
    {% endfor %}   
    </div>
      <div class="" id="change_pwd_error" style="display:none">
        {% for flashMessage in app.session.flashbag.get('errornotice') %}
        <div class="gq-well gq-id-file-error-text">
            <span class="login-warning-icon"></span>
            <div class="login-warning-text" id="flash-msg">{{ flashMessage }}</div>
        </div>
        {% endfor %}
        </div>
       {% if messages %}
        {% if messages|length > 0 %}  
                {% if msgType is defined and msgType=="" %}
            <div class="" id="newMsg"> 
                    <ul class="mail_secion">
                        {% for key, message in messages %}
                            <li class="{% if message.read == 1 or message.sent.id == userId %} disable {% endif %} clearfix" id="msg-{{message.id}}">
								{% if parameters[1] is defined %}
								 <a href="{{ base_url }}messages/{{message.id}}?{{parameters[1]}}">
								{%else%}
								 <a href="{{ base_url }}messages/{{message.id}}">
								{%endif%}
								<span class="chat_pic">
										{% if ('ROLE_APPLICANT' in userRole) %}
										<img class="profile-img" src="{{ asset('public/images/PROFILE.png') }}" alt="chat_pic"/>
										{% else %}
										{% if  message.sent.userImage is defined and message.sent.userImage!=''%}
										{% set userimg = message.sent.userImage %}
										{% else %}
										{% set userimg = 'PROFILE.png' %}
										{% endif %}
											{% if message.sent.userImage is defined and message.sent.userImage != "" %}
											<img src="{{ amazon_link~'user-'~message.sent.id~'/'~message.sent.userImage }}" alt="chat_pic"/>
											{% else %}
											<img class="profile-img" src="{{ asset('public/images/PROFILE.png') }}" alt="chat_pic"/>
											{% endif %}
										{% endif %}
								</span>
								<span class="chat_content">
									<span class="chat_name">
										 {% if message.sent.id is defined and message.sent.id == curuser and  message.replymid=="0"%}                                                    
										<strong>You</strong>
										<span class="arrow"></span>
										<strong>{{message.sent.firstname}}</strong>
										{% elseif message.sent.id is defined %}
												{{message.sent.firstname}}
										{% endif %}
									</span>
										<span class="chat_content">
												<strong> 
													{% if message.replymid is defined and message.replymid != 0 %}                                       
																<span class="reply"></span>
																{% endif %}
																
																
																
																  {% if message.subject|length > 15 %}                                                                  
																	 {% set msgSubVal = message.subject|split(' ', 4) %}                                                                 
																	 {% if msgSubVal[1] is defined and  msgSubVal[2] is not defined and  msgSubVal[3] is not defined %}
																		{% set msgSubValarr = msgSubVal[0] %}
																	 {% elseif msgSubVal[2] is defined and  msgSubVal[3] is not defined %}
																		{% set msgSubValarr = msgSubVal[0]~' '~msgSubVal[1] %}
																	 {% elseif msgSubVal[3] is defined%}
																		{% set msgSubValarr = msgSubVal[0]~' '~msgSubVal[1]~' '~msgSubVal[2] %}  
																	 {% else %}
																		 {% set msgSubValarr = msgSubVal[0] %}
																	 {% endif %}
																	 {{ msgSubValarr |raw ~ ' -'}}
																{% else %}
																  
																	{% set msgSubVal = message.subject|split(' ', 3) %}
																	 {% if msgSubVal[1] is defined and  msgSubVal[2] is not defined and  msgSubVal[3] is not defined %}
																		{% set msgSubValarr = msgSubVal[0] %}
																	 {% elseif msgSubVal[1] is defined and msgSubVal[2] is defined and  msgSubVal[3] is not defined %}
																		{% set msgSubValarr = msgSubVal[0]~' '~msgSubVal[1] %}
																	 {% else %}
																		 {% set msgSubValarr = msgSubVal[0] %}
																	 {% endif %}
																	 {{ msgSubValarr |raw ~ ' -'}} 
																{% endif %}
												</strong>
														  {% if message.message|length > 15 %}
																{% set msgVal = message.message|split(' ', 4) %}
																 {% if msgVal[1] is defined %}
																	{% set msgarr = msgVal[0]%}
																 {% elseif msgVal[1] is defined and msgVal[2] is defined%}
																	{% set msgarr = msgVal[0]~' '~msgVal[1] %}
																 {% else %}
																	 {% set msgarr = msgVal[0] %}
																 {% endif %}
																{{ msgarr ~ '...' |raw}}
															{% else %}
																{% set msgVal = message.message|split(' ', 4) %}
																{% if msgVal[1] is defined %}
																	{% set msgarr = msgVal[0]%}
																 {% elseif msgVal[1] is defined and msgVal[2] is defined%}
																	{% set msgarr = msgVal[0]~' '~msgVal[1] %}
																 {% else %}
																	 {% set msgarr = msgVal[0] %}
																 {% endif %}
																{{ msgarr ~ '...' |raw}}
														   {% endif %}
										</span>
								</span>
                                    <span class="date_time">{{ message.created | date("d/m/y") }}</span>
								</a>
                            </li>
                        {% endfor %}
                    </ul>
                    <div class="floater_add_icon" title="Add New Message">
                             <a href="{{ base_url }}messages/compose{% if parameters[1] is defined %}?{{parameters[1]}}{% endif %}" ><i class="material-icons add">add</i> </a>
                    </div>
                <div>
                    {# display navigation for pages - paginator_navigator #}
                    {% if messages|length > 0 and paginator.getTotalPages() > 1 %}                    
                        {{ include('GqAusUserBundle:Paginator:paginator_navigator.html.twig', {'paginator' : paginator}) }}
                    {% endif %}
                </div>
            </div>
                {% endif %}
            {% endif %}
      
{% else %}
         <div class="">
            <div class="left" id="noMessages">
                <ul class="mail_secion message">
                    <li><strong>{{no_messages}}</strong></li>
                </ul>
                <div class="floater_add_icon" title="Add New Message">
                        <a href="{{ base_url }}messages/compose{% if parameters[1] is defined %}?{{parameters[1]}}{% endif %}">
                                <i class="material-icons add">add</i>
                        </a>
                </div>
            </div>
         </div>
        {% endif %}
    {% if msgID is defined %}
        <div class="mail_compose_section view-message">
            
            {% set userSubject = '' %}
            {%set i = 0%}
            {% for message in replymsgarr %}  
            {% if i == 0 %} {% set userSubject = message.message.subject %}{% endif %}
           {# {% if userSubject|length > 30 %}
                      {% set userSubject123 = userSubject|raw[:30] %}{% endif %}   #}                                     
            {%set i = i+1 %}
            {% endfor %}
             {% if userSubject|length > 15 %}
                {% set userSubArr = userSubject|split(' ', 4) %}
                {% if userSubArr[1] is defined and  userSubArr[2] is not defined and  userSubArr[3] is not defined %}
                    {% set newuserSubject = userSubArr[0]%}
                 {% elseif userSubArr[2] is defined and  userSubArr[3] is not defined%}
                    {% set newuserSubject = userSubArr[0]~' '~userSubArr[1] %}
                 {% elseif userSubArr[3] is defined%}
                           {% set newuserSubject = userSubArr[0]~' '~userSubArr[1]~' '~userSubArr[2] %}
                
                 {% endif %}
            {% else %}
                {% set userSubArr = userSubject|split(' ', 4) %}
                {% if userSubArr[1] is defined and  userSubArr[2] is not defined and  userSubArr[3] is not defined %}
                    {% set newuserSubject = userSubArr[0]%}
                 {% elseif userSubArr[2] is defined and  userSubArr[3] is not defined %}
                    {% set newuserSubject = userSubArr[0]~' '~userSubArr[1] %}
                 {% else %}
                     {% set newuserSubject = userSubArr[0] %}
                 {% endif %}
            {% endif %} 
                <div class="title_bar">  {{ userSubject }}               
                        <span><a href="{{ base_url }}messages"><i class="material-icons arrow_back">arrow_back</i></a></span>
                </div>

                <div class="chat_room">
                     {% for message in replymsgarr %}
                        <div class="chat_box {% if message.from == " from me" %}from {% else %} to {% endif %} ">
                                <div class="person_profile clearfix">
                                        <span class="chat_pic">
                                                {% if ('ROLE_APPLICANT' in userRole) %}
                                            <img class="profile-img" src="{{ asset('public/images/PROFILE.png') }}" alt="chat_pic"/>
                                            {% else %}
                                            {% if  message.userImage is defined and message.userImage!=''%}
                                            {% set userimg = message.userImage %}
                                            {% else %}
                                            {% set userimg = 'PROFILE.png' %}
                                            {% endif %}
                                                {% if message.userImage != "" %}
                                                <img src="{{ amazon_link~'user-'~message.fromUserId~'/'~message.userImage }}" alt="chat_pic"/>
                                                {% else %}
                                                <img class="profile-img" src="{{ asset('public/images/PROFILE.png') }}" alt="chat_pic"/>
                                                {% endif %}
                                            {% endif %}
                                            
                                        </span>
                                        <span class="chat_name"><strong>{% if message.from == " from me" %} You {% else %} {{message.fromUserName}} {% endif %}</strong></span>
                                        <span class="date_time">{{ message.created | date("d/m/y") }}</span>
                                </div>
                                <p class="chat_content">
                                       {{message.content|raw}} 
                                </p>

                        </div>
                     {% endfor %}
                </div>

                <div class="btn_section">
                    
                    {% if msgType is defined and msgType=="reply" %}                 
                 <form onsubmit="formSubmitAction()" action="{{ path('saveMessage') }}" method="post" {{ form_enctype(composeformMobile) }}>
                    <input type="hidden" id="replymid" name="replymid" value="{{ replymid }}"/>
                    <span class="hidden">
                                    {% if user is defined and user != '' %}
                                {{ form_widget(composeformMobile.toUserName, {value  : userName}, {'attr': {'placeholder': '', 'readonly': 'true'} }) }}
                                {{ form_widget(composeformMobile.to, {value  : user}, {'attr': {'placeholder': '', 'readonly': 'true'} }) }}
                                {{ form_widget(composeformMobile.subject, {value  : sub}, {'attr': {'placeholder': ''} }) }}
                                {% endif %}
                    </span>

                {% if user is defined and user != '' %}
                            {{ form_widget(composeformMobile.message, {'attr': {'placeholder': 'Enter Message'} },{value  : '' }) }}
                        {% endif %}
                {{ form_widget(composeformMobile.save,{ 'label': ' ' , 'attr': {'class': 'button send_link active','onclick':'return validateNewMessage($("#compose_toUserName").val(),$("#compose_subject").val(),$("#compose_message").val());'}}) }}
                 {{ form_end(composeformMobile) }}
               
                {% else %}
                   <form name="reply" action="{{ base_url }}messages/compose{% if parameters[1] is defined %}?{{parameters[1]}}{% endif %}" method="post">
                          <input type="hidden" id="reply_id" name="reply_id" value="{{msgID}}"/>
                      <input type="submit" class="button reply_link" value="REPLY"/>
                          </form>
                
                 {% endif %}
                 </div>
                
               
        </div>
    {% endif %}
    
    
    
    {% if msgType is defined and msgType=="new" %}
        <div class="new_message_section mobile_new_message_section">
            <div class="title_bar">NEW MESSAGE
                    <span><a href="{{ base_url }}messages"><i class="material-icons close">close</i></a></span>
            </div>
            <div class="new_msg_section ">
                <form onsubmit="formSubmitAction()" action="{{ path('saveMessage') }}" method="post" {{ form_enctype(composeformMobile) }}>
                    <div class="input_section">
                    <label>To:</label>
                    <input type="hidden" id="replymid" name="replymid" value="{{ replymid }}"/>
                    {% if user is defined and user != '' %}
                    {{ form_widget(composeformMobile.toUserName, {value  : userName}, {'attr': {'placeholder': '', 'readonly': 'true'} }) }}
                    {{ form_widget(composeformMobile.to, {value  : user}, {'attr': {'placeholder': '', 'readonly': 'true'} }) }}
                    {% else %}
                    {{ form_widget(composeformMobile.toUserName, {'attr': {'placeholder': '','onKeyUp':'searchUsernames(".mobto")','class':'mobto'} }) }}
                    {{ form_widget(composeformMobile.to, {'attr': {'placeholder': ''} }) }}
                    {% endif %}
                    </div>
                    <div class="input_section">
                    <label>Subject:</label>
                    {% if user is defined and user != '' %}
                    {{ form_widget(composeformMobile.subject, {value  : sub}, {'attr': {'placeholder': ''} }) }}
                    {% else %}
                    {{ form_widget(composeformMobile.subject, {'attr': {'placeholder': ''} }) }}
                    {% endif %}
                    </div>
                    {% if user is defined and user != '' %}
                    {{ form_widget(composeformMobile.message, {value  : '' }, {'attr': {'placeholder': 'Enter Message'} }) }}
                    {% else %}
                    {{ form_widget(composeformMobile.message, {'attr': {'placeholder': 'Enter Message'} }) }}
                    {% endif %}
                    <div class="textarea-clone"></div>  
                    </div>
                    <div class="btn_section">
                      <a class="checkform-changed button cancel_link hidden-xs" data-toggle="modal" data-target="" >
                          <button class="btn btn-grey" name="compose[discard]" id="compose_discard" type="reset">CANCEL</button></a>
                     {{ form_widget(composeformMobile.save,{ 'label': 'Send' , 'attr': {'class': 'button send_link','onclick':'return validateNewMessage($("#compose_toUserName").val(),$("#compose_subject").val(),$("#compose_message").val());'}}) }}	                        </div>
                     {{ form_end(composeformMobile) }}
                     </form>
            </div>
        {% endif %}
    </div>
    </div>
    </div>
    </div>
 <!-- FOR MOBILE -->

 {% endblock %}
 
{% block javascripts %}       
    <script src="{{ asset('public/js/jquery.form.js') }}"></script>
    <script src="{{ asset('public/js/custom-form-elements.js') }}"></script> 
    
{% endblock %}