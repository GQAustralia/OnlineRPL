{% extends 'base.html.twig' %}
{% block title %}GQ - RPL Messages Inbox{% endblock %}
{% block stylesheets %}
<link rel="stylesheet" href="{{ asset('public/css/pages/all/candidate.css') }}">
<link rel="stylesheet" href="{{ asset('public/css/jquery-ui.css') }}">
{% endblock %}
{% block body %}
<div class="body_section message_section">
    <div class="container">		
        <!-- FOR DESKTOP -->
    <div class="row">
        <!-- getting current path -->
        {% set currentPath = app.request.uri %}
        {% set parameters = currentPath|split('?') %}
        {% set userRole = app.security.getToken().getUser().getRoles() %}
        {% set userId = app.security.getToken().getUser().getId() %} 
        {% if messages%}
            {% if messages|length > 0 %}
                <div class="hidden-xs col-sm-6 col-md-6 col-lg-6">
                    <div class="left">
                        <ul class="mail_secion">
                            {% for key, message in messages %}
                                <li class="{% if message.read == 1 or message.sent.id == userId %} disable {% endif %} clearfix" id="msg-{{message.id}}">
                                    
                                        <span class="chat_pic">
                                            {% if ('ROLE_APPLICANT' in userRole) %}
                                            <img class="profile-img" src="{{ asset('public/images/PROFILE.png') }}" alt="chat_pic"/>
                                            {% else %}
                                            {% if  message.sent.userImage is defined and message.sent.userImage!=''%}
                                            {% set userimg = message.sent.userImage %}
                                            {% else %}
                                            {% set userimg = 'PROFILE.png' %}
                                            {% endif %}
                                                {% if message.sent.userImage is defined and message.sent.userImage != "" %}
                                                <img src="{{ amazon_link~'user-'~message.sent.id~'/'~message.sent.userImage }}" alt="chat_pic"/>
                                                {% else %}
                                                <img class="profile-img" src="{{ asset('public/images/PROFILE.png') }}" alt="chat_pic"/>
                                                {% endif %}
                                            {% endif %}
                                        </span>
                                        <span class="chat_content">
                                            <span class="chat_name">
                                                {% if message.sent.id is defined and message.sent.id == curuser and  message.replymid=="0"%}                                                    
                                                    <strong>You</strong>
                                                    <span class="arrow"></span>
                                                    <strong>{{message.inbox.firstname}}</strong>
                                                    {% elseif message.sent.id is defined %}
                                                            {{message.sent.firstname}}
                                                    {% endif %}
                                            </span>
                                                <span class="chat_content">
                                                         <strong> 
                                                            {% if message.replymid is defined and message.replymid != 0 %}                                       
                                                            <span class="reply"></span>
                                                            {% endif %}
                                                            
                                                            {% if parameters[1] is defined %}
                                                             <a href="{{ base_url }}messages/{{message.id}}?{{parameters[1]}}">
                                                            {%else%}
                                                             <a href="{{ base_url }}messages/{{message.id}}">
                                                            {%endif%}
                                                            
                                                            {% if message.subject|length > 10 %}
                                                                {{ message.subject|raw[:10] ~ ' -' }}
                                                            {% else %}
                                                                {{ message.subject|raw ~  ' -' }}   
                                                            {% endif %}
                                                            </a> 
                                                        </strong>
                                                        {% if message.message|length > 20 %}
                                                            {{ message.message|raw[:20] ~ '...' }}
                                                        {% else %}
                                                            {{ message.message|raw }}   
                                                        {% endif %}
                                                </span>
                                        </span>
                                        <span class="date_time">{{ message.created | date("d/m/y") }}</span>
                                </li>

                            {% endfor %}
                        </ul>
                    <div class="floater_add_icon" title="Add New Message">
                            <a href="{{ base_url }}messages/compose">
                                    <i class="material-icons add">add</i>
                            </a>
                    </div>
                    </div>
                    <div>
                    {# display navigation for pages - paginator_navigator #}
                    {% if messages|length > 0 and paginator.getTotalPages() > 1 %}                    
                        {{ include('GqAusUserBundle:Paginator:paginator_navigator.html.twig', {'paginator' : paginator}) }}
                    {% endif %}
                </div>
                </div>
                
                {% endif %}
        {% else %}
         <div class="hidden-xs col-sm-6 col-md-6 col-lg-6">
            <div class="left">
                <ul class="mail_secion message">
                    <li><strong>{{no_messages}}</strong></li>
                </ul>
                <div class="floater_add_icon" title="Add New Message">
                        <a href="{{ base_url }}messages/compose">
                                <i class="material-icons add">add</i>
                        </a>
                </div>
            </div>
         </div>
        {% endif %}
        
        <div class="hidden-xs col-sm-6 col-md-6 col-lg-6">
        {% if msgID is defined %}
            {% set userSubject = '' %}
            {%set i = 0%}
            {% for message in replymsgarr %}  
            {% if i == 0 %} {% set userSubject = message.message.subject %}{% endif %}
            {% if userSubject|length > 15 %}
                      {% set userSubject = userSubject|raw[:15] %}{% endif %}                                        
            {%set i = i+1 %}
            {% endfor %}
        <div class="mail_compose_section hidden-xs">
                <div class="title_bar">  {{ userSubject }}
                        <span><a href="{{ base_url }}messages"><i class="material-icons close">close</i></a></span>
                </div>
                <div class="chat_room">
                    {% for message in replymsgarr %}                    
                        <div class="chat_box {% if message.from == " from me" %}from {% else %} to {% endif %} ">
                            <div class="person_profile clearfix">
                                    <span class="chat_pic">
                                                {% if ('ROLE_APPLICANT' in userRole) %}
                                            <img class="profile-img" src="{{ asset('public/images/PROFILE.png') }}" alt="chat_pic"/>
                                            {% else %}
                                            {% if  message.userImage is defined and message.userImage!=''%}
                                            {% set userimg = message.userImage %}
                                            {% else %}
                                            {% set userimg = 'PROFILE.png' %}
                                            {% endif %}
                                                {% if message.userImage != "" %}
                                                <img src="{{ amazon_link~'user-'~message.toUserId~'/'~message.userImage }}" alt="chat_pic"/>
                                                {% else %}
                                                <img class="profile-img" src="{{ asset('public/images/PROFILE.png') }}" alt="chat_pic"/>
                                                {% endif %}
                                            {% endif %}
                                            
                                    </span>
                                    <span class="chat_name">
                                            <strong>
                                                    {% if message.from == "from me" %} You {% else %} {{message.fromUserName}} {% endif %}
                                            </strong>
                                    </span>
                                    <span class="date_time">{{ message.created | date('h:i A') }}</span>
                            </div>
                            <p class="chat_content">
                                   {{message.content|raw}}
                            </p>
                        </div>
                     {% endfor %}
                        {% if msgType is defined and msgType=="reply" %}                            
                        <form action="{{ path('saveMessage') }}" method="post" {{ form_enctype(composemsgForm) }}>
                        <input type="hidden" id="replymid" name="replymid" value="{{ replymid }}"/>
                        <div class="chat_box to">
                                <div class="person_profile">
                                        <span class="chat_pic">                                           
                                           {% if ('ROLE_APPLICANT' in userRole) %}
                                            <img class="profile-img" src="{{ asset('public/images/PROFILE.png') }}" alt="chat_pic"/>
                                            {% else %}
                                            {% if  toUserImage is defined and toUserImage!=''%}
                                            {% set userimg = toUserImage %}
                                            {% else %}
                                            {% set userimg = 'PROFILE.png' %}
                                            {% endif %}
                                                {% if toUserImage != "" %}
                                                <img src="{{amazon_link~'user-'~toUserVal~'/'~toUserImage }}" alt="chat_pic"/>
                                                {% else %}
                                                <img class="profile-img" src="{{ asset('public/images/PROFILE.png') }}" alt="chat_pic"/>
                                                {% endif %}
                                            {% endif %}
                                        </span>
                                        <span class="chat_name"><strong>
                                            {% if user is defined and user != '' %}
                                               You
                                        <span class="hidden">                                              
                                        {{ form_widget(composemsgForm.toUserName, {value  : userName}, {'attr': {'placeholder': '', 'readonly': 'true'} }) }}
                                        {{ form_widget(composemsgForm.to, {value  : user}, {'attr': {'placeholder': '', 'readonly': 'true'} }) }}
                                        </span>
                                        </strong></span>
                                        <span class="hidden">
                                        {{ form_widget(composemsgForm.subject, {value  : sub}, {'attr': {'placeholder': '',} }) }}
                                        </span>
                                        {% endif %}
                                        <span class="date_time">{{ 'now' | date('h:i A') }}</span>
                                </div>
                               {% if user is defined and user != '' %}
                                       {{ form_widget(composemsgForm.message, {'attr': {'placeholder': 'Enter Message','msgType':'reply'} },{value  : '' }) }}
                                {% endif %}
                        </div>
                      {% endif %}   
                </div>
                {% if messages%}
                    {% if message.replymid is defined and curuser == message.sent.id%}
                    <div class="btn_section">                                                            
                    </div>
                {% elseif msgType is defined and msgType=="reply" %}
                <div class="btn_section">
                        <a class="checkform-changed button cancel_link hidden-xs"  href="{{ base_url }}messages/{{msgID}}">
                                     CANCEL</a>
                                {{ form_widget(composemsgForm.save,{ 'label': 'SEND' , 'attr': {'class': 'button send_link'}}) }} 
                </div>
                 {{ form_end(composemsgForm) }}
                {% else %}
                    <div class="btn_section">
                        <form name="reply" action="{{ base_url }}messages/compose" method="post">
                       <input type="hidden" id="reply_id" name="reply_id" value="{{msgID}}"/>
                           <input type="Submit" class="button reply_link" value="REPLY"/>
                       </form>
                           <a href="{{ base_url }}messages/compose" >NEW MESSAGE   <i class="material-icons add">add</i> </a>                                                          
                    </div>
                    {% endif %}
                {% endif %}
                </div>
        {% endif %}
        {% if messages %}
        {% if messages|length > 0 %}
        {% else %}
            <div class="gq-msg-row-bg">
                <div class="col-xs-12">
                    <span class="msg-checkmark-icon">
                        <center>No Messages found</center>
                    </span>
                </div>
            </div>
        {% endif %}
    {% endif %}
    <div class="">
    {% for flashMessage in app.session.flashbag.get('msgnotice') %}
    <div class="row" id="profile_suc_msg">
    <div class="gq-id-files-upload-success-text">
      <span style="width:100%;">{{ flashMessage }}</span>
    </div>
    </div>
    {% endfor %}
        <div class="" id="change_pwd_error" >
        {% for flashMessage in app.session.flashbag.get('errornotice') %}
        <div class="gq-well well gq-id-files-upload-success-text">
            <span class="login-warning-icon"></span>
            <div class="login-warning-text" id="flash-msg">{{ flashMessage }}</div>
        </div>
        {% endfor %}
        </div>
    </div>
    {% if msgType is defined and msgType=="new" %}
        <div class="new_message_section">
            <div class="title_bar">NEW MESSAGE
                    <span><a href="{{ base_url }}messages"><i class="material-icons close">close</i></a></span>
            </div>
            <div class="new_msg_section">
                <form action="{{ path('saveMessage') }}" method="post" {{ form_enctype(composemsgForm) }}>
                    <div class="input_section">
                    <label>To:</label>
                    <input type="hidden" id="replymid" name="replymid" value="{{ replymid }}"/>
                    {% if user is defined and user != '' %}
                    {{ form_widget(composemsgForm.toUserName, {value  : userName}, {'attr': {'placeholder': '', 'readonly': 'true'} }) }}
                    {{ form_widget(composemsgForm.to, {value  : user}, {'attr': {'placeholder': '', 'readonly': 'true'} }) }}
                    {% else %}
                    {{ form_widget(composemsgForm.toUserName, {'attr': {'placeholder': '','onKeyUp':'searchUsernames("#compose_toUserName")'} }) }}
                    {{ form_widget(composemsgForm.to, {'attr': {'placeholder': ''} }) }}
                    {% endif %}
                    </div>
                    <div class="input_section">
                    <label>Subject:</label>
                    {% if user is defined and user != '' %}
                    {{ form_widget(composemsgForm.subject, {value  : sub}, {'attr': {'placeholder': ''} }) }}
                    {% else %}
                    {{ form_widget(composemsgForm.subject, {'attr': {'placeholder': ''} }) }}
                    {% endif %}
                    </div>
                    {% if user is defined and user != '' %}
                    {{ form_widget(composemsgForm.message, {value  : '' }, {'attr': {'placeholder': 'Enter Message'} }) }}
                    {% else %}
                    {{ form_widget(composemsgForm.message, {'attr': {'placeholder': 'Enter Message'} }) }}
                    {% endif %}
                    <div class="textarea-clone"></div>  
                    </div>
                    <div class="btn_section">
                      <a class="checkform-changed button cancel_link hidden-xs" data-toggle="modal" data-target="" >
                          <button class="btn btn-grey" name="compose[discard]" id="compose_discard" type="reset">CANCEL</button></a>
                     {{ form_widget(composemsgForm.save,{ 'label': 'SEND' , 'attr': {'class': 'button send_link'}}) }}	                        </div>
                     {{ form_end(composemsgForm) }}
                     </form>
            </div>
        {% endif %}
    </div>
     </div>
        </div>

   
    <!-- FOR DESKTOP -->
    
    

 {% endblock %}
 
{% block javascripts %}       
    <script src="{{ asset('public/js/jquery.form.js') }}"></script>
    <script src="{{ asset('public/js/custom-form-elements.js') }}"></script>    
    <script>
        function getMessageElement(){
         var msgTypeVal=$('#compose_message').attr('msgType');
         if(msgTypeVal!='undefined' && msgTypeVal==='reply'){
          $('.chat_room').animate({
           scrollTop: 1000
          });
         }
        }
        $(document).ready(function(){
         getMessageElement();
        
        });

</script> 
{% endblock %}